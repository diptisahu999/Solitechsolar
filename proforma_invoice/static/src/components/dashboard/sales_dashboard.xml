<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="proforma_invoice.SalesDashboard" owl="1">
        <div class="o_sales_dashboard h-100 d-flex flex-column">
            <div class="dashboard-header text-white px-4 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0 text-white">Sales Dashboard</h2>
                    <button class="btn btn-sm btn-light-refresh" t-on-click="refreshDashboard">
                        <i class="fa fa-refresh me-1"/>Refresh
                    </button>
                </div>
            </div>

            <div class="flex-grow-1 overflow-auto bg-light">
                <div t-if="state.isLoading" class="d-flex justify-content-center align-items-center h-100">
                    <i class="fa fa-spinner fa-spin fa-3x text-primary"/>
                </div>
                <div t-else="" class="p-4">
                    <ul class="nav nav-pills mb-4">
                        <li class="nav-item">
                            <a class="nav-link" t-att-class="{ 'active': state.activeTab === 'overview' }" href="#" t-on-click.prevent="() => state.activeTab = 'overview'">Overview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" t-att-class="{ 'active': state.activeTab === 'opportunities' }" href="#" t-on-click.prevent="() => state.activeTab = 'opportunities'">Opportunity Analysis</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" t-att-class="{ 'active': state.activeTab === 'quotations' }" href="#" t-on-click.prevent="() => state.activeTab = 'quotations'">Sales &amp; Revenue</a>
                        </li>
                        <li t-if="state.dashboardData.is_sales_manager" class="nav-item">
                             <a class="nav-link" t-att-class="{ 'active': state.activeTab === 'team' }" href="#" t-on-click.prevent="() => state.activeTab = 'team'">Team Performance</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <t t-if="state.activeTab === 'overview'">
                            <div class="row">
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-primary text-white me-3"><i class="fa fa-users"/></div><div><p class="text-muted mb-0 small">Leads</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.leads_count"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-warning text-white me-3"><i class="fa fa-rocket"/></div><div><p class="text-muted mb-0 small">Opportunities</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.opportunities_count"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-info text-white me-3"><i class="fa fa-line-chart"/></div><div><p class="text-muted mb-0 small">Pipeline Value</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.pipeline_overview.pipeline_revenue)"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success text-white me-3"><i class="fa fa-bullseye"/></div><div><p class="text-muted mb-0 small">Lead Conversion</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.conversion_rate"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success text-white me-3"><i class="fa fa-check-square-o"/></div><div><p class="text-muted mb-0 small">Confirmed Orders</p><h3 class="mb-0"><t t-esc="state.dashboardData.quotation_analysis.confirmed_count"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success-dark text-white me-3"><i class="fa fa-inr"/></div><div><p class="text-muted mb-0 small">Sales Revenue</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.quotation_analysis.confirmed_revenue)"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success-dark text-white me-3"><i class="fa fa-balance-scale"/></div><div><p class="text-muted mb-0 small">Avg. Order Value</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.quotation_analysis.average_order_value)"/></h3></div></div></div></div>
                                <div class="col-lg-3 col-6 mb-4"><div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-secondary text-white me-3"><i class="fa fa-file-text-o"/></div><div><p class="text-muted mb-0 small">Confirmed Proformas</p><h3 class="mb-0"><t t-esc="state.dashboardData.proforma_analysis.posted_count"/></h3></div></div></div></div>
                            </div>
                        </t>

                        <t t-if="state.activeTab === 'opportunities'">
                            <div class="row mb-4">
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-primary text-white me-3"><i class="fa fa-users"/></div><div><p class="text-muted mb-0 small">Open Leads</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.leads_count"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-warning text-white me-3"><i class="fa fa-rocket"/></div><div><p class="text-muted mb-0 small">Open Opportunities</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.opportunities_count"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-info text-white me-3"><i class="fa fa-line-chart"/></div><div><p class="text-muted mb-0 small">Pipeline Value</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.pipeline_overview.pipeline_revenue)"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success text-white me-3"><i class="fa fa-bullseye"/></div><div><p class="text-muted mb-0 small">Lead Conversion</p><h3 class="mb-0"><t t-esc="state.dashboardData.pipeline_overview.conversion_rate"/></h3></div></div></div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-lg-4 col-6">
                                    <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Win Rate</p><h3 class="mb-0"><t t-esc="state.dashboardData.opportunity_analysis.win_rate"/></h3></div></div>
                                </div>
                                <div class="col-lg-4 col-6">
                                    <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Average Deal Size</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.opportunity_analysis.avg_deal_size)"/></h3></div></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-lg-8 mb-4">
                                    <div class="card h-100"><div class="card-header">Pipeline Value by Stage</div><div class="card-body"><div style="height: 300px;"><canvas t-ref="pipelineValueByStageChart"/></div></div></div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100"><div class="card-header">Opportunities by Source</div><div class="card-body"><div style="height: 300px;"><canvas t-ref="oppsBySourceChart"/></div></div></div>
                                </div>
                                <div class="col-lg-8 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">Top 5 Open Deals</div>
                                        <div class="card-body p-0">
                                            <table class="table table-hover mb-0">
                                                <thead><tr><th>Opportunity</th><th>Customer</th><th class="text-end">Expected Revenue</th></tr></thead>
                                                <tbody>
                                                    <tr t-foreach="state.dashboardData.opportunity_analysis.top_open_deals" t-as="deal" t-key="deal.id">
                                                        <td><t t-esc="deal.name"/></td>
                                                        <td><t t-esc="deal.partner_id[1]"/></td>
                                                        <td class="text-end fw-bold"><t t-esc="formatCurrency(deal.expected_revenue)"/></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100"><div class="card-header">Opportunities by Stage (Count)</div><div class="card-body"><div style="height: 300px;"><canvas t-ref="oppsByStageChart"/></div></div></div>
                                </div>
                            </div>
                        </t>
                        
                        <!-- Sales & Revenue Tab -->
                        <t t-if="state.activeTab === 'quotations'">
                            <div class="row mb-4">
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-secondary text-white me-3"><i class="fa fa-pencil-square-o"/></div><div><p class="text-muted mb-0 small">Draft Quotations</p><h3 class="mb-0"><t t-esc="state.dashboardData.quotation_analysis.draft_count"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success text-white me-3"><i class="fa fa-check-square-o"/></div><div><p class="text-muted mb-0 small">Confirmed Orders</p><h3 class="mb-0"><t t-esc="state.dashboardData.quotation_analysis.confirmed_count"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-secondary text-white me-3"><i class="fa fa-file-o"/></div><div><p class="text-muted mb-0 small">Draft Proformas</p><h3 class="mb-0"><t t-esc="state.dashboardData.proforma_analysis.draft_count"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-primary text-white me-3"><i class="fa fa-file-text-o"/></div><div><p class="text-muted mb-0 small">Confirmed Proformas</p><h3 class="mb-0"><t t-esc="state.dashboardData.proforma_analysis.posted_count"/></h3></div></div></div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success-dark text-white me-3"><i class="fa fa-inr"/></div><div><p class="text-muted mb-0 small">Sales Revenue</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.quotation_analysis.confirmed_revenue)"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-success-dark text-white me-3"><i class="fa fa-balance-scale"/></div><div><p class="text-muted mb-0 small">Avg. Order Value</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.quotation_analysis.average_order_value)"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-primary text-white me-3"><i class="fa fa-money"/></div><div><p class="text-muted mb-0 small">Proforma Revenue</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.proforma_analysis.posted_revenue)"/></h3></div></div></div>
                                </div>
                                <div class="col-lg-3 col-6 mb-4">
                                    <div class="card kpi-card h-100"><div class="card-body d-flex align-items-center"><div class="kpi-icon bg-info text-white me-3"><i class="fa fa-paper-plane-o"/></div><div><p class="text-muted mb-0 small">Sent Quotations</p><h3 class="mb-0"><t t-esc="state.dashboardData.quotation_analysis.sent_count"/></h3></div></div></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12 mb-4">
                                    <div class="card h-100"><div class="card-header">12-Month Sales Trend</div><div class="card-body"><div style="height: 350px;"><canvas t-ref="salesOverTimeChart"/></div></div></div>
                                </div>
                                <div class="col-lg-7 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">Top 5 Selling Products</div>
                                        <div class="card-body p-0">
                                            <table class="table table-hover mb-0">
                                                <thead><tr><th>Product</th><th class="text-end">Revenue</th></tr></thead>
                                                <tbody>
                                                    <tr t-foreach="state.dashboardData.quotation_analysis.top_products" t-as="product" t-key="product.name">
                                                        <td><t t-esc="product.name"/></td>
                                                        <td class="text-end fw-bold"><t t-esc="formatCurrency(product.revenue)"/></td>
                                                    </tr>
                                                    <t t-if="!state.dashboardData.quotation_analysis.top_products.length">
                                                        <tr><td colspan="2" class="text-center text-muted p-4">No product sales data available.</td></tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5 mb-4">
                                    <div class="card h-100"><div class="card-header">Sales by Product Category</div><div class="card-body"><div style="height: 300px;"><canvas t-ref="salesByCategoryChart"/></div></div></div>
                                </div>
                            </div>
                        </t>

                        <t t-if="state.activeTab === 'team'">
                            <t t-if="state.dashboardData.team_analysis and state.dashboardData.team_analysis.overview">
                                <div class="row mb-4">
                                    <div class="col-lg col-6 mb-4">
                                        <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Team Leads</p><h3 class="mb-0"><t t-esc="state.dashboardData.team_analysis.overview.leads_count"/></h3></div></div>
                                    </div>
                                    <div class="col-lg col-6 mb-4">
                                        <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Team Opportunities</p><h3 class="mb-0"><t t-esc="state.dashboardData.team_analysis.overview.opportunities_count"/></h3></div></div>
                                    </div>
                                    <div class="col-lg col-6 mb-4">
                                        <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Team Pipeline Value</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.team_analysis.overview.pipeline_revenue)"/></h3></div></div>
                                    </div>
                                    <div class="col-lg col-6 mb-4">
                                        <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Team Revenue</p><h3 class="mb-0"><t t-esc="formatCurrency(state.dashboardData.team_analysis.overview.total_revenue)"/></h3></div></div>
                                    </div>
                                    <div class="col-lg col-6 mb-4">
                                        <div class="card kpi-card h-100"><div class="card-body text-center"><p class="text-muted mb-1 small">Team Win Rate</p><h3 class="mb-0"><t t-esc="state.dashboardData.team_analysis.overview.win_rate"/></h3></div></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-8 mb-4">
                                        <div class="card h-100"><div class="card-header">Team's 12-Month Sales Trend</div><div class="card-body"><div style="height: 350px;"><canvas t-ref="teamSalesTrendChart"/></div></div></div>
                                    </div>
                                    <div class="col-lg-4 mb-4">
                                        <div class="card h-100"><div class="card-header">Revenue Contribution by Member</div><div class="card-body"><div style="height: 350px;"><canvas t-ref="teamMemberPerformanceChart"/></div></div></div>
                                    </div>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="alert alert-info" role="alert">
                                    <i class="fa fa-info-circle me-2"/>
                                    Team performance data could not be loaded. To view this tab, please ensure you are set as the "Team Leader" of a Sales Team in the CRM app.
                                </div>
                            </t>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>